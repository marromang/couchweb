### Backup and Restore ###
En un entorno en produccion hay que hacer copias de los datos de cara a posibles fallos y así evitar la pérdida de datos y minimizar la inconsistencia de datos
en caso de tener que hacer alguna restauración.

Couchbase proporciona dos herramientas

    cbbackupmgr (solo disponible en la version de pago)
    cbbackup y cbrestore (disponible en todas las verisionas)

Dada la naturaleza de los servidores de Couchbase, no se puede realizar una copia en tiempo de ejecución y un snapshot del cluster completo ya que los datos
están en constante cambio.


### cbbackup y cbrestore ###
Proporcionan copias incrementeales y completas.

Al realizar una restauración, usa la última copia completa y al menos una de las incrementales.

Existen dos tipos de copias incrementales:
    Incrementales-diferenciales
    Incrementales-acumulativas

Incrementales-diferenciales:
	Almacenan los cambios desde la ultima copia. Se crean rapido ya que la cantidad de datos suele ser pequeña, pero su restauración es más larga que las 
	incrementales-acumulativas.

	-----insertar fotito------
	Lunes: cambios desde la ultima copia completa del domingo
	Martes: cambios desde el lunes
	Miercoles: cambios desde el martes
	...
	Una restauracion hecha el miercoles usaría la completa del domingo más las incrementales del lunes y martes.

Incrementales-acumulativas
	Contienen todos los cambios desde la última copia completa. Sus restauraciones son mas rapidas, pero las copias requieren mas tiempo y espacio en disco.
	-----insertar fotito------
	Lunes: cambios desde la ultima del domingo
	Martes: cambios desde la ultima del domingo
	...
	Una restauracion el miercoles usario la copia del domingo y la acumulativa del martes

Combinacion de ambas
	Para mejorar el rendimiento del proceso de restauracion, se pueden combinar ambos metodos.
	-----insertar fotito------
	En funcion del dia, se hace una u otra
	Jueves: acumulativa
	Resto: diferencial
	Si se restaura el sabado se usa la del domungo y la del jueves y la del viernes

### cbbackup ###
Puede crear copias de un cluster, un bucket completo , en un nodo o un solo bucket en un solo nodo.

cbbackup [options] [source] [backup-dir] -u [admin] -p [password]

Donde [backup-dir] es el directorio en el que se almacenaran los datos. Si no existe, se crea, siempre cuando el directorio padre exista.

Ejemplos de copias completa y 2 incrementales

cbbackup http://HOST:8091 /backup-42 -u Administrator -p password
cbbackup http://HOST:8091 /backup-42 -m diff -u Administrator -p password
cbbackup http://HOST:8091 /backup-42 -m diff -u Administrator -p password			

Para crear una copia nueva, hay que cambiar de directorio.
Para la version gratuita, solo esta disponible la copia completa.

Ejemplos de completa, 2 diferenciales y 1 acumulativa en un solo nodo
cbbackup couchbase://HOST:8091 /backup-43 -m full --single-node -u Administrator -p password
cbbackup couchbase://HOST:8091 /backup-43 -m diff --single-node -u Administrator -p password 
cbbackup couchbase://HOST:8091 /backup-43 -m diff --single-node -u Administrator -p password  
cbbackup couchbase://HOST:8091 /backup-43 -m accu --single-node -u Administrator -p password 

Ejemplos de 1 completa + dos diferecniales y 1 acumulativa en un solo nodo.
cbbackup couchbase://HOST:8091 /backup-43 -m full --single-node -u Administrator -p password \  
cbbackup couchbase://HOST:8091 /backup-43 -m diff --single-nodecbbackup \
couchbase://HOST:8091 /backup-43 -m diff --single-node -u Administrator -p password \
cbbackup couchbase://HOST:8091 /backup-43 -m accu --single-node -u Administrator -p password]			

Descripcion
Para crear una copia, el nodo (o cluster) tiene que esta operativo. Se tiene que ejecutar en local (o a traves de ssh o similares)
Nos permite realizar copias de:
	todos los buckets de un cluster
	un solo bucket de un cluster
	todos los bucktes de un solo nodo
	un solo bucket en un nodo

Por defecto, se hace una copia de los indices secundarios del cluster. Si se hace un acopia de un solo nodo, solo xe haran copia de los indices de dicho nodo
y solo si tiene el servicio de indexado activado

La herramienta se encuentra en  /opt/couchbase/bin/cbbackup

Opciones:
-h, --help 	ayuda
-b BUCKET_SOURCE, --bucket-source=BUCKET_SOURCE 	bucket de origen 
--single-node 	para indicar que se hara en un solo nodo
-m MODE, --mode=MODE 	tipo de backup
	full para copias completas
	diff para diferenciales
    accu para acumulativas

-i ID, --id=ID 	copiar elementos que contengan ese id
-k KEY, --key=KEY 	copiar elementos cuya clave contengan la expresion regular que se indique
-n, --dry-run 	no se hace copia, solo comprueba la conexion
-u USERNAME, --username=USERNAME  usuario
-p PASSWORD, --password=PASSWORD  contraseña
-s, --ssl 	habilitar ssl
-t THREADS, --threads=THREADS 	hilos simultaneos para la transeferencia
-v, --verbose 	nivel de los mensajes, a mas v, mas mensajes
--silent 	solo muestra los error
-x EXTRA, --extra=EXTRA 	para indicar configuraciones especiales
	backoff_cap=10 	tiempo maximo de espera para volver a balancear la carga
	batch_max_bytes=400000 	numero de bytes por trozo
	batch_max_size=1000 	numero de documentos por trozo
	cbb_max_mb=100000 	tamaño maximo a partir del cual se separaran los ficheros generads
	conflict_resolve=1 	resolver conflictos con otros datos
	data_only=0 	si vale 1, transfiere solo los datos de un fichero de backup
	###design_doc_only=0 	For value 1, transfer only design documents from a backup file or cluster. Default: 0.
	max_retry=10 	numero maximo de intenntos hasta parar
	mcd_compatible=1 	si vale 0, muestra los datos completos
	nmv_retry=1 	si vale 1, vuelve a intentar la transferencia tras un mensaje NOT_MY_VBUCKET 
	recv_min_bytes=4096 	bytes de cada trama TCP/IP
	rehash=0 	si vale 1, refresca el id de cada item
	report=5 	trozos emviados antes de modificar la barra de estado en la consola
	report_full=2000 	numero de tramas transmitidas antes de mostrar informacion del proceso en consola
	seqno=0 	valor de inicio del numero de secuencia
	try_xwm=1 	transferencia de datos con los metadatos
	uncompress=0 	si esta en 1, restaura sin comprimir


Ejemplos

Cluster completo
cbbackup http://HOST:8091 ~/backups -u Administrator -p password
Se crea la siguiente estructura de directorios suponiendo que hay 2 buckets (my_name y sasl) y dos nodos (N1 y N2)
~/backups
        bucket-my_name
            N1
            N2
            design.json
            index.json
        bucket-sasl
            N1
            N2
            design.json
            index.json
            

Un solo bucket en un cluster
cbbackup http://HOST:8091 /backups/backup-20120501 -u Administrator -p password -b default

Varios buckets en un nodo
cbbackup http://HOST:8091 /backups/ -u Administrator -p password --single-node

Un bucket en un nodo
cbbackup http://HOST:8091 /backups -u Administrator -p password --single-node  -b bucket_name

Todas las claves de un bucket con el prefijo 'object'
cbbackup http://HOST:8091 /backups/backup-20120501 -u Administrator -p password -b bucket_name -k '^object.*'

Copia completa de un cluster
cbbackup -m full http://example.com:8091 /backups/backup-1 -u Administrator -p password

Copia diferencial en un cluster
cbbackup -m diff http://example.com:8091 /backups/backup-1 -u Administrator -p password

Copia acumulativa en un cluster
cbbackup -m accu http://example.com:8091 /backups/backup-1 -u Administrator -p password


### cbrestore ###
Herramienta de restauracion de datos


cbrestore [options] [backup-dir] [destination]

Donde [backup-dir] es el directorio en el que se almacenaran los datos. Si no existe, se crea, siempre cuando el directorio padre exista.

Aspectos a tener en cuenta:
	Los datos escritos a un fichero en disco, se restauran en la RAM
	Sobre los indices secundarios
		Si la copia los contiene, tambien son parte del proceso de restauracion
		Se almacenan sin los nombres de los nodos, que son pasados posteriormente (CREATE INDEX). Si almacena los id de os indices.
		Cuando los indices ya etan restaurados, se tienen que construir a mano con BUILD INDEX.
	Resolucion de conflictos
		Por defecto, se comprueba que los datos no se hayan sobreescrito de manera incorrecta
		A veces, hay documentos que no coincidean con el contenido de la copia si se han eliminado muy recientemente.

La herramienta esta en /opt/couchbase/bin/cbrestore

Opciones
-h, --help 	ayuda
-a, --add 	Used to not overwrite existing items in the destination. Use add instead of set.
-b BUCKET_SOURCE, --bucket-source=BUCKET_SOURCE 	bucket de origen 
-B BUCKET_DESTINATION, --bucket-destination=BUCKET_DESTINATION bucket de destino. Si no se especifica, coge el mismo que el origen
--from-date=FROM_DATE 	fecha desde la que se quiere restaurar. Por defecto, restaura desde el primer dia.
-i ID, --id=ID 	copiar elementos que contengan ese id
-k KEY, --key=KEY 	copiar elementos cuya clave contengan la expresion regular que se indique
-m MODE, --mode=MODE 
-n, --dry-run 	no se hace copia, solo comprueba la conexion
-u USERNAME, --username=USERNAME  usuario
-p PASSWORD, --password=PASSWORD  contraseña
--single-node para indicar que se hara en un solo nodo
-t THREADS, --threads=THREADS 	hilos simultaneos para la transeferencia
-v, --verbose 	nivel de los mensajes, a mas v, mas mensajes
-x EXTRA, --extra=EXTRA 	para indicar configuraciones especiales
	backoff_cap=10 	tiempo maximo de espera para volver a balancear la carga
	batch_max_bytes=400000 	numero de bytes por trozo
	batch_max_size=1000 	numero de documentos por trozo
	cbb_max_mb=100000 	tamaño maximo a partir del cual se separaran los ficheros generads
	conflict_resolve=1 	resolver conflictos con otros datos
	data_only=0 	si vale 1, transfiere solo los datos de un fichero de backup
	###design_doc_only=0 	For value 1, transfer only design documents from a backup file or cluster. Default: 0.
	max_retry=10 	numero maximo de intenntos hasta parar
	mcd_compatible=1 	si vale 0, muestra los datos completos
	nmv_retry=1 	si vale 1, vuelve a intentar la transferencia tras un mensaje NOT_MY_VBUCKET 
	recv_min_bytes=4096 	bytes de cada trama TCP/IP
	rehash=0 	si vale 1, refresca el id de cada item
	report=5 	trozos emviados antes de modificar la barra de estado en la consola
	report_full=2000 	numero de tramas transmitidas antes de mostrar informacion del proceso en consola
	seqno=0 	valor de inicio del numero de secuencia
	try_xwm=1 	transferencia de datos con los metadatos
	uncompress=0 	si esta en 1, restaura sin comprimir

Ejemplos

Basicos
cbrestore ~/backup http://192.0.2.0:8091 -b travel-sample
cbrestore ~/backup couchbase://192.0.2.0:8091 -b travel-sample
cbrestore ~/backup memcached://192.0.2.0:11211 -b travel-sample		
   
Restauracion incremental entre 01-08-2014 y 03-08-2014
Example for restoring data incrementally
cbrestore -b travel-sample -B travel-sample --from-date=2014-08-01 --to-date=2014-08-03 ~/backup http://192.0.2.0:8091

Restauracion sin resolucion de conflictos
cbrestore -b travel-sample -B travel-sample -x conflict_resolve=0 ~/backup http://192.0.2.0:8091
